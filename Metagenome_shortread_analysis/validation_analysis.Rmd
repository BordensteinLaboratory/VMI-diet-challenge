---
title: "Validation Analysis"
author: "Liz Mallott"
date: "12/14/2020"
output: html_document
fig_width: 5
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Importing libraries

The libraries below are required for this analysis.

```{r libraries}
library(tidyverse)
library(vegan)
library(ggplot2)
library(cowplot)
library(glmmTMB)
library(multcomp)
```

## Importing data

Bray-Curtis and Jaccard matrices were created in QIIME2 for COGs and KOs so we could easily rarefy the data and remove low-abundance samples. We created matrices for the combined dataset and individual studies. So, we are importing those matrices here, after ensuring they and the metadata files have the same sampleID order.

```{r import}
#AGP studies
PATH='agp'
bray_cog_agp = as.dist(read.table(file.path(PATH,"distance-matrix-bray-cog.tsv"), 
                                  header = T))
bray_ko_agp = as.dist(read.table(file.path(PATH,"distance-matrix-bray-ko.tsv"), 
                                 header = T))
jaccard_cog_agp = as.dist(read.table(file.path(PATH,"distance-matrix-jaccard-cog.tsv"), 
                                     header = T))
jaccard_ko_agp = as.dist(read.table(file.path(PATH,"distance-matrix-jaccard-ko.tsv"), 
                                    header = T))
metadata_agp = read.csv(file.path(PATH,"metadata_agp.csv"), header = T)

#GW studies
PATH='gw'
bray_cog_gw = as.dist(read.table(file.path(PATH,"distance-matrix-bray-cog.tsv"), 
                                  header = T))
bray_ko_gw = as.dist(read.table(file.path(PATH,"distance-matrix-bray-ko.tsv"), 
                                 header = T))
jaccard_cog_gw = as.dist(read.table(file.path(PATH,"distance-matrix-jaccard-cog.tsv"), 
                                     header = T))
jaccard_ko_gw = as.dist(read.table(file.path(PATH,"distance-matrix-jaccard-ko.tsv"), 
                                    header = T))
metadata_gw = read.csv(file.path(PATH,"metadata_gw.csv"), header = T)

bray_cog_gwonly = as.dist(read.table(file.path(PATH,"distance-matrix-bray-cog-gwonly.tsv"), 
                                  header = T))
bray_ko_gwonly = as.dist(read.table(file.path(PATH,"distance-matrix-bray-ko-gwonly.tsv"), 
                                 header = T))
jaccard_cog_gwonly = as.dist(read.table(file.path(PATH,"distance-matrix-jaccard-cog-gwonly.tsv"),header = T))
jaccard_ko_gwonly = as.dist(read.table(file.path(PATH,"distance-matrix-jaccard-ko-gwonly.tsv"),
                                    header = T))
metadata_gwonly = read.csv(file.path(PATH,"metadata_gw_gwonly.csv"), header = T)

#HMP studies
PATH='hmp'
bray_cog_hmp = as.dist(read.table(file.path(PATH,"distance-matrix-bray-cog.tsv"), 
                                  header = T))
bray_ko_hmp = as.dist(read.table(file.path(PATH,"distance-matrix-bray-ko.tsv"), 
                                 header = T))
jaccard_cog_hmp = as.dist(read.table(file.path(PATH,"distance-matrix-jaccard-cog.tsv"), 
                                     header = T))
jaccard_ko_hmp = as.dist(read.table(file.path(PATH,"distance-matrix-jaccard-ko.tsv"), 
                                    header = T))
metadata_hmp = read.csv(file.path(PATH,"metadata_hmp.csv"), header = T)

bray_cog_hmp_hous = as.dist(read.table(file.path(PATH,"distance-matrix-bray-cog-hous.txt"), 
                                  header = T))
bray_ko_hmp_hous = as.dist(read.table(file.path(PATH,"distance-matrix-bray-ko-hous.txt"), 
                                 header = T))
jaccard_cog_hmp_hous = as.dist(read.table(file.path(PATH,"distance-matrix-jaccard-cog-hous.txt"), 
                                     header = T))
jaccard_ko_hmp_hous = as.dist(read.table(file.path(PATH,"distance-matrix-jaccard-ko-hous.txt"), 
                                    header = T))
metadata_hmp_hous = read.csv(file.path(PATH,"metadata_hmp_hous.csv"), header = T)

bray_cog_hmp_stl = as.dist(read.table(file.path(PATH,"distance-matrix-bray-cog-stl.txt"), 
                                  header = T))
bray_ko_hmp_stl = as.dist(read.table(file.path(PATH,"distance-matrix-bray-ko-stl.txt"), 
                                 header = T))
jaccard_cog_hmp_stl = as.dist(read.table(file.path(PATH,"distance-matrix-jaccard-cog-stl.txt"), 
                                     header = T))
jaccard_ko_hmp_stl = as.dist(read.table(file.path(PATH,"distance-matrix-jaccard-ko-stl.txt"), 
                                    header = T))
metadata_hmp_stl = read.csv(file.path(PATH,"metadata_hmp_stl.csv"), header = T)

#Combined studies
PATH='combined'
bray_cog_combined = as.dist(read.table(file.path(PATH,"distance-matrix-bray-cog.tsv"), 
                                  header = T))
bray_ko_combined = as.dist(read.table(file.path(PATH,"distance-matrix-bray-ko.tsv"), 
                                 header = T))
jaccard_cog_combined = as.dist(read.table(file.path(PATH,"distance-matrix-jaccard-cog.tsv"), 
                                     header = T))
jaccard_ko_combined = as.dist(read.table(file.path(PATH,"distance-matrix-jaccard-ko.tsv"), 
                                    header = T))
metadata_combined = read.csv(file.path(PATH,"metadata_combined.csv"), header = T)
```

## PERMANOVAs

A PERMANOVA was performed to assess the influence of ethnicity alone for individual studies, and the influence of both ethnicity and study for the combined dataset. Matched pairs were included as a variable to control for interindividual variation in age, alcohol consumption, antibiotic history, BMI, contraceptive use, habitual diet, sex, and smoking history.

### AGP samples
```{r permanova-agp}
adonis2(bray_cog_agp ~ race + pair, data = metadata_agp, by = "margin", permutations = 4999)
adonis2(bray_ko_agp ~ race + pair, data = metadata_agp, by = "margin", permutations = 4999)
adonis2(jaccard_cog_agp ~ race + pair, data = metadata_agp, by = "margin", permutations = 4999)
adonis2(jaccard_ko_agp ~ race + pair, data = metadata_agp, by = "margin", permutations = 4999)
```

```{r permanova-agp-simple}
adonis2(bray_cog_agp ~ race, data = metadata_agp, by = "margin", permutations = 4999)
adonis2(bray_ko_agp ~ race, data = metadata_agp, by = "margin", permutations = 4999)
adonis2(jaccard_cog_agp ~ race, data = metadata_agp, by = "margin", permutations = 4999)
adonis2(jaccard_ko_agp ~ race, data = metadata_agp, by = "margin", permutations = 4999)
```

### GW samples
```{r permanova-gw}
adonis2(bray_cog_gw ~ race + pair, data = metadata_gw, by = "margin", permutations = 4999)
adonis2(bray_ko_gw ~ race + pair, data = metadata_gw, by = "margin", permutations = 4999)
adonis2(jaccard_cog_gw ~ race + pair, data = metadata_gw, by = "margin", permutations = 4999)
adonis2(jaccard_ko_gw ~ race + pair, data = metadata_gw, by = "margin", permutations = 4999)
```
```{r permanova-gw-simple}
adonis2(bray_cog_gw ~ race, data = metadata_gw, by = "margin", permutations = 4999)
adonis2(bray_ko_gw ~ race, data = metadata_gw, by = "margin", permutations = 4999)
adonis2(jaccard_cog_gw ~ race, data = metadata_gw, by = "margin", permutations = 4999)
adonis2(jaccard_ko_gw ~ race, data = metadata_gw, by = "margin", permutations = 4999)
```

```{r permanova-gw-only}
adonis2(bray_cog_gwonly ~ race + pair, data = metadata_gwonly, by = "margin", 
        permutations = 4999)
adonis2(bray_ko_gwonly ~ race + pair, data = metadata_gwonly, by = "margin", 
        permutations = 4999)
adonis2(jaccard_cog_gwonly ~ race + pair, data = metadata_gwonly, by = "margin", 
        permutations = 4999)
adonis2(jaccard_ko_gwonly ~ race + pair, data = metadata_gwonly, by = "margin", 
        permutations = 4999)
```

### HMP samples
```{r permanova-hmp}
adonis2(bray_cog_hmp ~ race + pair, data = metadata_hmp, by = "margin", permutations = 4999)
adonis2(bray_ko_hmp ~ race + pair, data = metadata_hmp, by = "margin", permutations = 4999)
adonis2(jaccard_cog_hmp ~ race + pair, data = metadata_hmp, by = "margin", permutations = 4999)
adonis2(jaccard_ko_hmp ~ race + pair, data = metadata_hmp, by = "margin", permutations = 4999)
```

```{r permanova-hmp-simple}
adonis2(bray_cog_hmp ~ race, data = metadata_hmp, by = "margin", permutations = 4999)
adonis2(bray_ko_hmp ~ race, data = metadata_hmp, by = "margin", permutations = 4999)
adonis2(jaccard_cog_hmp ~ race, data = metadata_hmp, by = "margin", permutations = 4999)
adonis2(jaccard_ko_hmp ~ race, data = metadata_hmp, by = "margin", permutations = 4999)
```
```{r permanova-hmp-hous}
adonis2(bray_cog_hmp_hous ~ race + pair, data = metadata_hmp_hous, by = "margin", 
        permutations = 4999)
adonis2(bray_ko_hmp_hous ~ race + pair, data = metadata_hmp_hous, by = "margin", 
        permutations = 4999)
adonis2(jaccard_cog_hmp_hous ~ race + pair, data = metadata_hmp_hous, by = "margin", 
        permutations = 4999)
adonis2(jaccard_ko_hmp_hous ~ race + pair, data = metadata_hmp_hous, by = "margin", 
        permutations = 4999)
```

```{r permanova-hmp-stl}
adonis2(bray_cog_hmp_stl ~ race + pair, data = metadata_hmp_stl, by = "margin", 
        permutations = 4999)
adonis2(bray_ko_hmp_stl ~ race + pair, data = metadata_hmp_stl, by = "margin", 
        permutations = 4999)
adonis2(jaccard_cog_hmp_stl ~ race + pair, data = metadata_hmp_stl, by = "margin", 
        permutations = 4999)
adonis2(jaccard_ko_hmp_stl ~ race + pair, data = metadata_hmp_stl, by = "margin", 
        permutations = 4999)
```


### Combined data
```{r permanova-combined}
perm = how(nperm = 4999)
setBlocks(perm) = with(metadata_combined, study)
adonis2(bray_cog_combined ~ race + study/pair, data = metadata_combined, 
        by = "margin", permutations = perm)
adonis2(bray_ko_combined ~ race + study/pair, data = metadata_combined, 
        by = "margin", permutations = perm)
adonis2(jaccard_cog_combined ~ race + study/pair, data = metadata_combined, 
        by = "margin", permutations = perm)
adonis2(jaccard_ko_combined ~ race + study/pair, data = metadata_combined, 
        by = "margin", permutations = perm)
```

```{r permanova-combined-simple}
adonis2(bray_cog_combined ~ race, data = metadata_combined, 
        by = "margin", permutations = 4999)
adonis2(bray_ko_combined ~ race, data = metadata_combined, 
        by = "margin", permutations = 4999)
adonis2(jaccard_cog_combined ~ race, data = metadata_combined, 
        by = "margin", permutations = 4999)
adonis2(jaccard_ko_combined ~ race, data = metadata_combined, 
        by = "margin", permutations = 4999)
```

### NMDS plots

NMDS plots were used to visualize differences between white and Black individuals in the combined data.

```{r nmds}
mds_bray_ko<-metaMDS(bray_ko_combined, k=2, trymax=999)
mds_bray_ko_points<-mds_bray_ko$points
mds_bray_ko_points2<-merge(x=mds_bray_ko_points, y = metadata_combined, 
                                  by.x = "row.names", by.y = "SampleID")
brayko <- ggplot(mds_bray_ko_points2, aes(x = MDS1, y = MDS2, 
                                                 color = race, shape = study)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8))) +
  stat_ellipse(aes(x = MDS1, y = MDS2, group = race, linetype = race), 
               type = "t", level = 0.95) + 
  ggtitle("Bray-Curtis - KOs")
brayko

mds_bray_cog<-metaMDS(bray_cog_combined, k=2, trymax=999)
mds_bray_cog_points<-mds_bray_cog$points
mds_bray_cog_points2<-merge(x=mds_bray_cog_points, y = metadata_combined, 
                                  by.x = "row.names", by.y = "SampleID")
braycog <- ggplot(mds_bray_cog_points2, aes(x = MDS1, y = MDS2, 
                                                 color = race, shape = study)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8))) +
  stat_ellipse(aes(x = MDS1, y = MDS2, group = race, linetype = race), 
               type = "t", level = 0.95) + 
  ggtitle("Bray-Curtis - COGs")
braycog

mds_jaccard_ko<-metaMDS(jaccard_ko_combined, k=2, trymax=999)
mds_jaccard_ko_points<-mds_jaccard_ko$points
mds_jaccard_ko_points2<-merge(x=mds_jaccard_ko_points, y = metadata_combined, 
                                  by.x = "row.names", by.y = "SampleID")
jaccardko <- ggplot(mds_jaccard_ko_points2, aes(x = MDS1, y = MDS2, 
                                                 color = race, shape = study)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8))) +
  stat_ellipse(aes(x = MDS1, y = MDS2, group = race, linetype = race), 
               type = "t", level = 0.95) + 
  ggtitle("Jaccard - KOs")
jaccardko

mds_jaccard_cog<-metaMDS(jaccard_cog_combined, k=2, trymax=999)
mds_jaccard_cog_points<-mds_jaccard_cog$points
mds_jaccard_cog_points2<-merge(x=mds_jaccard_cog_points, y = metadata_combined, 
                                  by.x = "row.names", by.y = "SampleID")
jaccardcog <- ggplot(mds_jaccard_cog_points2, aes(x = MDS1, y = MDS2, 
                                                 color = race, shape = study)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8))) +
  stat_ellipse(aes(x = MDS1, y = MDS2, group = race, linetype = race), 
               type = "t", level = 0.95) + 
  ggtitle("Jaccard - COGs")
jaccardcog

tiff(file = "nmds_plot_combined.tif", res = 300, width = 18, height = 14, units="in")
legend1 = get_legend(brayko + theme(legend.box.margin = margin(0, 0, 0, 12)))
col1 = plot_grid(brayko + theme(legend.position = "none"),
                 jaccardko + theme(legend.position = "none"),
                 nrow = 2, ncol = 1, labels = c('A', 'C'), 
                 label_size = 20)
col2 = plot_grid(braycog + theme(legend.position = "none"),
                 jaccardcog + theme(legend.position = "none"),
                 nrow = 2, ncol = 1, labels = c('B', 'D'), 
                 label_size = 20)
plot_grid(col1, col2, legend1, 
          nrow = 1, ncol = 3, rel_widths = c(1.5, 1.5, 0.75), align = "hv", 
          axis = "t")
dev.off()
```
```{r nmds_agp}
mds_bray_ko<-metaMDS(bray_ko_agp, k=2, trymax=999)
mds_bray_ko_points<-mds_bray_ko$points
mds_bray_ko_points2<-merge(x=mds_bray_ko_points, y = metadata_agp, 
                                  by.x = "row.names", by.y = "SampleID")
brayko <- ggplot(mds_bray_ko_points2, aes(x = MDS1, y = MDS2, 
                                                 color = race, shape = study)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8))) +
  stat_ellipse(aes(x = MDS1, y = MDS2, group = race, linetype = race), 
               type = "t", level = 0.95) + 
  ggtitle("Bray-Curtis - KOs")
brayko

mds_bray_cog<-metaMDS(bray_cog_agp, k=2, trymax=999)
mds_bray_cog_points<-mds_bray_cog$points
mds_bray_cog_points2<-merge(x=mds_bray_cog_points, y = metadata_agp, 
                                  by.x = "row.names", by.y = "SampleID")
braycog <- ggplot(mds_bray_cog_points2, aes(x = MDS1, y = MDS2, 
                                                 color = race, shape = study)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8))) +
  stat_ellipse(aes(x = MDS1, y = MDS2, group = race, linetype = race), 
               type = "t", level = 0.95) + 
  ggtitle("Bray-Curtis - COGs")
braycog

mds_jaccard_ko<-metaMDS(jaccard_ko_agp, k=2, trymax=999)
mds_jaccard_ko_points<-mds_jaccard_ko$points
mds_jaccard_ko_points2<-merge(x=mds_jaccard_ko_points, y = metadata_agp, 
                                  by.x = "row.names", by.y = "SampleID")
jaccardko <- ggplot(mds_jaccard_ko_points2, aes(x = MDS1, y = MDS2, 
                                                 color = race, shape = study)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8))) +
  stat_ellipse(aes(x = MDS1, y = MDS2, group = race, linetype = race), 
               type = "t", level = 0.95) + 
  ggtitle("Jaccard - KOs")
jaccardko

mds_jaccard_cog<-metaMDS(jaccard_cog_agp, k=2, trymax=999)
mds_jaccard_cog_points<-mds_jaccard_cog$points
mds_jaccard_cog_points2<-merge(x=mds_jaccard_cog_points, y = metadata_agp, 
                                  by.x = "row.names", by.y = "SampleID")
jaccardcog <- ggplot(mds_jaccard_cog_points2, aes(x = MDS1, y = MDS2, 
                                                 color = race, shape = study)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8))) +
  stat_ellipse(aes(x = MDS1, y = MDS2, group = race, linetype = race), 
               type = "t", level = 0.95) + 
  ggtitle("Jaccard - COGs")
jaccardcog

tiff(file = "nmds_plot_agp.tif", res = 300, width = 18, height = 14, units="in")
legend1 = get_legend(brayko + theme(legend.box.margin = margin(0, 0, 0, 12)))
col1 = plot_grid(brayko + theme(legend.position = "none"),
                 jaccardko + theme(legend.position = "none"),
                 nrow = 2, ncol = 1, labels = c('A', 'C'), 
                 label_size = 20)
col2 = plot_grid(braycog + theme(legend.position = "none"),
                 jaccardcog + theme(legend.position = "none"),
                 nrow = 2, ncol = 1, labels = c('B', 'D'), 
                 label_size = 20)
plot_grid(col1, col2, legend1, 
          nrow = 1, ncol = 3, rel_widths = c(1.5, 1.5, 0.75), align = "hv", 
          axis = "t")
dev.off()
```

```{r nmds_gw}
mds_bray_ko<-metaMDS(bray_ko_gw, k=2, trymax=999)
mds_bray_ko_points<-mds_bray_ko$points
mds_bray_ko_points2<-merge(x=mds_bray_ko_points, y = metadata_gw, 
                                  by.x = "row.names", by.y = "SampleID")
brayko <- ggplot(mds_bray_ko_points2, aes(x = MDS1, y = MDS2, 
                                                 color = race, shape = study)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8))) +
  stat_ellipse(aes(x = MDS1, y = MDS2, group = race, linetype = race), 
               type = "t", level = 0.95) + 
  ggtitle("Bray-Curtis - KOs")
brayko

mds_bray_cog<-metaMDS(bray_cog_gw, k=2, trymax=999)
mds_bray_cog_points<-mds_bray_cog$points
mds_bray_cog_points2<-merge(x=mds_bray_cog_points, y = metadata_gw, 
                                  by.x = "row.names", by.y = "SampleID")
braycog <- ggplot(mds_bray_cog_points2, aes(x = MDS1, y = MDS2, 
                                                 color = race, shape = study)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8))) +
  stat_ellipse(aes(x = MDS1, y = MDS2, group = race, linetype = race), 
               type = "t", level = 0.95) + 
  ggtitle("Bray-Curtis - COGs")
braycog

mds_jaccard_ko<-metaMDS(jaccard_ko_gw, k=2, trymax=999)
mds_jaccard_ko_points<-mds_jaccard_ko$points
mds_jaccard_ko_points2<-merge(x=mds_jaccard_ko_points, y = metadata_gw, 
                                  by.x = "row.names", by.y = "SampleID")
jaccardko <- ggplot(mds_jaccard_ko_points2, aes(x = MDS1, y = MDS2, 
                                                 color = race, shape = study)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8))) +
  stat_ellipse(aes(x = MDS1, y = MDS2, group = race, linetype = race), 
               type = "t", level = 0.95) + 
  ggtitle("Jaccard - KOs")
jaccardko

mds_jaccard_cog<-metaMDS(jaccard_cog_gw, k=2, trymax=999)
mds_jaccard_cog_points<-mds_jaccard_cog$points
mds_jaccard_cog_points2<-merge(x=mds_jaccard_cog_points, y = metadata_gw, 
                                  by.x = "row.names", by.y = "SampleID")
jaccardcog <- ggplot(mds_jaccard_cog_points2, aes(x = MDS1, y = MDS2, 
                                                 color = race, shape = study)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8))) +
  stat_ellipse(aes(x = MDS1, y = MDS2, group = race, linetype = race), 
               type = "t", level = 0.95) + 
  ggtitle("Jaccard - COGs")
jaccardcog

tiff(file = "nmds_plot_gw.tif", res = 300, width = 18, height = 14, units="in")
legend1 = get_legend(brayko + theme(legend.box.margin = margin(0, 0, 0, 12)))
col1 = plot_grid(brayko + theme(legend.position = "none"),
                 jaccardko + theme(legend.position = "none"),
                 nrow = 2, ncol = 1, labels = c('A', 'C'), 
                 label_size = 20)
col2 = plot_grid(braycog + theme(legend.position = "none"),
                 jaccardcog + theme(legend.position = "none"),
                 nrow = 2, ncol = 1, labels = c('B', 'D'), 
                 label_size = 20)
plot_grid(col1, col2, legend1, 
          nrow = 1, ncol = 3, rel_widths = c(1.5, 1.5, 0.75), align = "hv", 
          axis = "t")
dev.off()
```
```{r nmds_gwonly}
mds_bray_ko<-metaMDS(bray_ko_gwonly, k=2, trymax=999)
mds_bray_ko_points<-mds_bray_ko$points
mds_bray_ko_points2<-merge(x=mds_bray_ko_points, y = metadata_gwonly, 
                                  by.x = "row.names", by.y = "SampleID")
brayko <- ggplot(mds_bray_ko_points2, aes(x = MDS1, y = MDS2, 
                                                 color = race, shape = study)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8))) +
  stat_ellipse(aes(x = MDS1, y = MDS2, group = race, linetype = race), 
               type = "t", level = 0.95) + 
  ggtitle("Bray-Curtis - KOs")
brayko

mds_bray_cog<-metaMDS(bray_cog_gwonly, k=2, trymax=999)
mds_bray_cog_points<-mds_bray_cog$points
mds_bray_cog_points2<-merge(x=mds_bray_cog_points, y = metadata_gwonly, 
                                  by.x = "row.names", by.y = "SampleID")
braycog <- ggplot(mds_bray_cog_points2, aes(x = MDS1, y = MDS2, 
                                                 color = race, shape = study)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8))) +
  stat_ellipse(aes(x = MDS1, y = MDS2, group = race, linetype = race), 
               type = "t", level = 0.95) + 
  ggtitle("Bray-Curtis - COGs")
braycog

mds_jaccard_ko<-metaMDS(jaccard_ko_gwonly, k=2, trymax=999)
mds_jaccard_ko_points<-mds_jaccard_ko$points
mds_jaccard_ko_points2<-merge(x=mds_jaccard_ko_points, y = metadata_gwonly, 
                                  by.x = "row.names", by.y = "SampleID")
jaccardko <- ggplot(mds_jaccard_ko_points2, aes(x = MDS1, y = MDS2, 
                                                 color = race, shape = study)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8))) +
  stat_ellipse(aes(x = MDS1, y = MDS2, group = race, linetype = race), 
               type = "t", level = 0.95) + 
  ggtitle("Jaccard - KOs")
jaccardko

mds_jaccard_cog<-metaMDS(jaccard_cog_gwonly, k=2, trymax=999)
mds_jaccard_cog_points<-mds_jaccard_cog$points
mds_jaccard_cog_points2<-merge(x=mds_jaccard_cog_points, y = metadata_gwonly, 
                                  by.x = "row.names", by.y = "SampleID")
jaccardcog <- ggplot(mds_jaccard_cog_points2, aes(x = MDS1, y = MDS2, 
                                                 color = race, shape = study)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8))) +
  stat_ellipse(aes(x = MDS1, y = MDS2, group = race, linetype = race), 
               type = "t", level = 0.95) + 
  ggtitle("Jaccard - COGs")
jaccardcog

tiff(file = "nmds_plot_gwonly.tif", res = 300, width = 18, height = 14, units="in")
legend1 = get_legend(brayko + theme(legend.box.margin = margin(0, 0, 0, 12)))
col1 = plot_grid(brayko + theme(legend.position = "none"),
                 jaccardko + theme(legend.position = "none"),
                 nrow = 2, ncol = 1, labels = c('A', 'C'), 
                 label_size = 20)
col2 = plot_grid(braycog + theme(legend.position = "none"),
                 jaccardcog + theme(legend.position = "none"),
                 nrow = 2, ncol = 1, labels = c('B', 'D'), 
                 label_size = 20)
plot_grid(col1, col2, legend1, 
          nrow = 1, ncol = 3, rel_widths = c(1.5, 1.5, 0.75), align = "hv", 
          axis = "t")
dev.off()
```


```{r nmds_hmp}
mds_bray_ko<-metaMDS(bray_ko_hmp, k=2, trymax=999)
mds_bray_ko_points<-mds_bray_ko$points
mds_bray_ko_points2<-merge(x=mds_bray_ko_points, y = metadata_hmp, 
                                  by.x = "row.names", by.y = "SampleID")
brayko <- ggplot(mds_bray_ko_points2, aes(x = MDS1, y = MDS2, 
                                                 color = race, shape = study)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8))) +
  stat_ellipse(aes(x = MDS1, y = MDS2, group = race, linetype = race), 
               type = "t", level = 0.95) + 
  ggtitle("Bray-Curtis - KOs")
brayko

mds_bray_cog<-metaMDS(bray_cog_hmp, k=2, trymax=999)
mds_bray_cog_points<-mds_bray_cog$points
mds_bray_cog_points2<-merge(x=mds_bray_cog_points, y = metadata_hmp, 
                                  by.x = "row.names", by.y = "SampleID")
braycog <- ggplot(mds_bray_cog_points2, aes(x = MDS1, y = MDS2, 
                                                 color = race, shape = study)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8))) +
  stat_ellipse(aes(x = MDS1, y = MDS2, group = race, linetype = race), 
               type = "t", level = 0.95) + 
  ggtitle("Bray-Curtis - COGs")
braycog

mds_jaccard_ko<-metaMDS(jaccard_ko_hmp, k=2, trymax=999)
mds_jaccard_ko_points<-mds_jaccard_ko$points
mds_jaccard_ko_points2<-merge(x=mds_jaccard_ko_points, y = metadata_hmp, 
                                  by.x = "row.names", by.y = "SampleID")
jaccardko <- ggplot(mds_jaccard_ko_points2, aes(x = MDS1, y = MDS2, 
                                                 color = race, shape = study)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8))) +
  stat_ellipse(aes(x = MDS1, y = MDS2, group = race, linetype = race), 
               type = "t", level = 0.95) + 
  ggtitle("Jaccard - KOs")
jaccardko

mds_jaccard_cog<-metaMDS(jaccard_cog_hmp, k=2, trymax=999)
mds_jaccard_cog_points<-mds_jaccard_cog$points
mds_jaccard_cog_points2<-merge(x=mds_jaccard_cog_points, y = metadata_hmp, 
                                  by.x = "row.names", by.y = "SampleID")
jaccardcog <- ggplot(mds_jaccard_cog_points2, aes(x = MDS1, y = MDS2, 
                                                 color = race, shape = study)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8))) +
  stat_ellipse(aes(x = MDS1, y = MDS2, group = race, linetype = race), 
               type = "t", level = 0.95) + 
  ggtitle("Jaccard - COGs")
jaccardcog

tiff(file = "nmds_plot_hmp.tif", res = 300, width = 18, height = 14, units="in")
legend1 = get_legend(brayko + theme(legend.box.margin = margin(0, 0, 0, 12)))
col1 = plot_grid(brayko + theme(legend.position = "none"),
                 jaccardko + theme(legend.position = "none"),
                 nrow = 2, ncol = 1, labels = c('A', 'C'), 
                 label_size = 20)
col2 = plot_grid(braycog + theme(legend.position = "none"),
                 jaccardcog + theme(legend.position = "none"),
                 nrow = 2, ncol = 1, labels = c('B', 'D'), 
                 label_size = 20)
plot_grid(col1, col2, legend1, 
          nrow = 1, ncol = 3, rel_widths = c(1.5, 1.5, 0.75), align = "hv", 
          axis = "t")
dev.off()
```

```{r nmds_hmp_hous}
mds_bray_ko<-metaMDS(bray_ko_hmp_hous, k=2, trymax=999)
mds_bray_ko_points<-mds_bray_ko$points
mds_bray_ko_points2<-merge(x=mds_bray_ko_points, y = metadata_hmp_hous, 
                                  by.x = "row.names", by.y = "SampleID")
brayko <- ggplot(mds_bray_ko_points2, aes(x = MDS1, y = MDS2, 
                                                 color = race, shape = study)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8))) +
  stat_ellipse(aes(x = MDS1, y = MDS2, group = race, linetype = race), 
               type = "t", level = 0.95) + 
  ggtitle("Bray-Curtis - KOs")
brayko

mds_bray_cog<-metaMDS(bray_cog_hmp_hous, k=2, trymax=999)
mds_bray_cog_points<-mds_bray_cog$points
mds_bray_cog_points2<-merge(x=mds_bray_cog_points, y = metadata_hmp_hous, 
                                  by.x = "row.names", by.y = "SampleID")
braycog <- ggplot(mds_bray_cog_points2, aes(x = MDS1, y = MDS2, 
                                                 color = race, shape = study)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8))) +
  stat_ellipse(aes(x = MDS1, y = MDS2, group = race, linetype = race), 
               type = "t", level = 0.95) + 
  ggtitle("Bray-Curtis - COGs")
braycog

mds_jaccard_ko<-metaMDS(jaccard_ko_hmp_hous, k=2, trymax=999)
mds_jaccard_ko_points<-mds_jaccard_ko$points
mds_jaccard_ko_points2<-merge(x=mds_jaccard_ko_points, y = metadata_hmp_hous, 
                                  by.x = "row.names", by.y = "SampleID")
jaccardko <- ggplot(mds_jaccard_ko_points2, aes(x = MDS1, y = MDS2, 
                                                 color = race, shape = study)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8))) +
  stat_ellipse(aes(x = MDS1, y = MDS2, group = race, linetype = race), 
               type = "t", level = 0.95) + 
  ggtitle("Jaccard - KOs")
jaccardko

mds_jaccard_cog<-metaMDS(jaccard_cog_hmp_hous, k=2, trymax=999)
mds_jaccard_cog_points<-mds_jaccard_cog$points
mds_jaccard_cog_points2<-merge(x=mds_jaccard_cog_points, y = metadata_hmp_hous, 
                                  by.x = "row.names", by.y = "SampleID")
jaccardcog <- ggplot(mds_jaccard_cog_points2, aes(x = MDS1, y = MDS2, 
                                                 color = race, shape = study)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8))) +
  stat_ellipse(aes(x = MDS1, y = MDS2, group = race, linetype = race), 
               type = "t", level = 0.95) + 
  ggtitle("Jaccard - COGs")
jaccardcog

tiff(file = "nmds_plot_hmp_hous.tif", res = 300, width = 18, height = 14, units="in")
legend1 = get_legend(brayko + theme(legend.box.margin = margin(0, 0, 0, 12)))
col1 = plot_grid(brayko + theme(legend.position = "none"),
                 jaccardko + theme(legend.position = "none"),
                 nrow = 2, ncol = 1, labels = c('A', 'C'), 
                 label_size = 20)
col2 = plot_grid(braycog + theme(legend.position = "none"),
                 jaccardcog + theme(legend.position = "none"),
                 nrow = 2, ncol = 1, labels = c('B', 'D'), 
                 label_size = 20)
plot_grid(col1, col2, legend1, 
          nrow = 1, ncol = 3, rel_widths = c(1.5, 1.5, 0.75), align = "hv", 
          axis = "t")
dev.off()
```

```{r nmds_hmp_stl}
mds_bray_ko<-metaMDS(bray_ko_hmp_stl, k=2, trymax=999)
mds_bray_ko_points<-mds_bray_ko$points
mds_bray_ko_points2<-merge(x=mds_bray_ko_points, y = metadata_hmp_stl, 
                                  by.x = "row.names", by.y = "SampleID")
brayko <- ggplot(mds_bray_ko_points2, aes(x = MDS1, y = MDS2, 
                                                 color = race, shape = study)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8))) +
  stat_ellipse(aes(x = MDS1, y = MDS2, group = race, linetype = race), 
               type = "t", level = 0.95) + 
  ggtitle("Bray-Curtis - KOs")
brayko

mds_bray_cog<-metaMDS(bray_cog_hmp_stl, k=2, trymax=999)
mds_bray_cog_points<-mds_bray_cog$points
mds_bray_cog_points2<-merge(x=mds_bray_cog_points, y = metadata_hmp_stl, 
                                  by.x = "row.names", by.y = "SampleID")
braycog <- ggplot(mds_bray_cog_points2, aes(x = MDS1, y = MDS2, 
                                                 color = race, shape = study)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8))) +
  stat_ellipse(aes(x = MDS1, y = MDS2, group = race, linetype = race), 
               type = "t", level = 0.95) + 
  ggtitle("Bray-Curtis - COGs")
braycog

mds_jaccard_ko<-metaMDS(jaccard_ko_hmp_stl, k=2, trymax=999)
mds_jaccard_ko_points<-mds_jaccard_ko$points
mds_jaccard_ko_points2<-merge(x=mds_jaccard_ko_points, y = metadata_hmp_stl, 
                                  by.x = "row.names", by.y = "SampleID")
jaccardko <- ggplot(mds_jaccard_ko_points2, aes(x = MDS1, y = MDS2, 
                                                 color = race, shape = study)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8))) +
  stat_ellipse(aes(x = MDS1, y = MDS2, group = race, linetype = race), 
               type = "t", level = 0.95) + 
  ggtitle("Jaccard - KOs")
jaccardko

mds_jaccard_cog<-metaMDS(jaccard_cog_hmp_stl, k=2, trymax=999)
mds_jaccard_cog_points<-mds_jaccard_cog$points
mds_jaccard_cog_points2<-merge(x=mds_jaccard_cog_points, y = metadata_hmp_stl, 
                                  by.x = "row.names", by.y = "SampleID")
jaccardcog <- ggplot(mds_jaccard_cog_points2, aes(x = MDS1, y = MDS2, 
                                                 color = race, shape = study)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8))) +
  stat_ellipse(aes(x = MDS1, y = MDS2, group = race, linetype = race), 
               type = "t", level = 0.95) + 
  ggtitle("Jaccard - COGs")
jaccardcog

tiff(file = "nmds_plot_hmp_stl.tif", res = 300, width = 18, height = 14, units="in")
legend1 = get_legend(brayko + theme(legend.box.margin = margin(0, 0, 0, 12)))
col1 = plot_grid(brayko + theme(legend.position = "none"),
                 jaccardko + theme(legend.position = "none"),
                 nrow = 2, ncol = 1, labels = c('A', 'C'), 
                 label_size = 20)
col2 = plot_grid(braycog + theme(legend.position = "none"),
                 jaccardcog + theme(legend.position = "none"),
                 nrow = 2, ncol = 1, labels = c('B', 'D'), 
                 label_size = 20)
plot_grid(col1, col2, legend1, 
          nrow = 1, ncol = 3, rel_widths = c(1.5, 1.5, 0.75), align = "hv", 
          axis = "t")
dev.off()
```
