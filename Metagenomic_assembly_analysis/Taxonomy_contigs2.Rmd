---
title: "Taxonomy Contigs"
author: "Liz Mallott"
date: "3/29/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Set up environment

```{r libraries}
library(tidyverse)
library(vegan)
library(fdrtool)
library(dendextend)
```

## Import data

Taxids with taxonomy are imported. Relative abundances of each taxid for individual samples are imported and vertically appended. We then reshape the dataframe. Taxid file and relative abundance file are joined to append taxonomy.

```{r import_taxonomy, echo = F}
taxid = read_tsv("taxonomy_files/tax.txt") %>% 
  select(-contig) %>% 
  distinct()
write_csv(taxid, "tables/unique_taxid.csv")
ra_files = list.files(path = "taxonomy_files", pattern = "run", full.names = T)
rel_abund_long = map_dfr(ra_files, read_tsv)
rel_abund_notax = rel_abund_long %>% pivot_wider(names_from = "id", values_from = "relative")
rel_abund = rel_abund_notax %>% right_join(taxid)
```

Metadata is imported.
```{r import_metadata, echo = F}
metadata = read_tsv("year2_sample_mapping.txt")
metadata2 = metadata %>% 
  mutate(Ethnicity = case_when(Ethnicity == "African_American" ~ "Black", 
                               Ethnicity == "Caucasian" ~ "White"))
```

## Filter data

The relative abundance table is transposed (without taxonomy) and file names are cleaned up. It is then joined with the metadata for PERMANOVA analyses. Individual tables for fecal and oral samples for each study period and for each ethnicity are created.
```{r ra_perm}
rel_abund_t = rel_abund_notax %>% 
  pivot_longer(cols = 2:163, names_to = "file_prefix", values_to = "relative_abundance") %>% 
  pivot_wider(names_from = "taxid", values_from = "relative_abundance") %>% 
  mutate_at("file_prefix", str_replace, "-", "_") %>% 
  left_join(metadata2)
relab_fecal = rel_abund_t %>% 
  filter(fecal_use == 1)
relab_fecal_filtered = relab_fecal %>% 
  mutate(total = rowSums(relab_fecal[,2:9395])) %>% 
  filter(total > 0) %>% 
  select_if(~ !is.numeric(.) || sum(.) != 0)
relab_fecal_filtered_black = relab_fecal_filtered %>% 
  filter(Ethnicity == "Black")
relab_fecal_filtered_white = relab_fecal_filtered %>% 
  filter(Ethnicity == "White")
relab_fecal_filtered_before = relab_fecal_filtered %>% 
  filter(`Study period` == "Before")
relab_fecal_filtered_during = relab_fecal_filtered %>% 
  filter(`Study period` == "During")
relab_fecal_filtered_after = relab_fecal_filtered %>% 
  filter(`Study period` == "After")

relab_oral= rel_abund_t %>% 
  filter(oral_use == 1)
relab_oral_filtered = relab_oral %>% 
  mutate(total = rowSums(relab_oral[,2:9395])) %>% 
  filter(total > 0) %>% 
  select_if(~ !is.numeric(.) || sum(.) != 0)
relab_oral_filtered_black = relab_oral_filtered %>% 
  filter(Ethnicity == "Black")
relab_oral_filtered_white = relab_oral_filtered %>% 
  filter(Ethnicity == "White")
relab_oral_filtered_before = relab_oral_filtered %>% 
  filter(`Study period` == "Before")
relab_oral_filtered_after = relab_oral_filtered %>% 
  filter(`Study period` == "After")
```

The relative abundance table is transposed (with species names but no taxids), column names are cleaned up, low abundance taxa (<1%) are removed, and it is joined with the metadata for individual taxa abundance analyses. Individual tables for fecal and oral samples for each study period and for each ethnicity are created.

```{r ra_taxabund}
rel_abund_tax_t = rel_abund %>% 
  filter(Kingdom == "Bacteria") %>% 
  select(-164) %>% 
  unite("Sci_name", Genus:Species, na.rm = F) %>% 
  pivot_longer(cols = 1:162, names_to = "file_prefix", values_to = "relative_abundance") %>%
  filter(Sci_name != "NA_NA") %>% 
  group_by(Sci_name, file_prefix) %>% 
  summarize(relative_abundance = sum(relative_abundance)) %>% 
  pivot_wider(names_from = "Sci_name", values_from = "relative_abundance") %>% 
  mutate_at("file_prefix", str_replace, "-", "_") %>% 
  select_if(~max(.) >= 0.01) %>% 
  left_join(metadata2)

rel_abund_tax_fecal = rel_abund_tax_t %>% 
  filter(fecal_use == 1) 
rel_abund_tax_fecal_ethnicity = rel_abund_tax_fecal %>% 
  group_by(Ethnicity) %>% 
  summarize_if(is.numeric, mean, na.rm = T)
write_csv(rel_abund_tax_fecal_ethnicity, "tables/relab_fecal.csv")
rel_abund_tax_fecal_before = rel_abund_tax_fecal %>% 
  filter(`Study period` == "Before")
rel_abund_tax_fecal_before_ethnicity = rel_abund_tax_fecal_before %>% 
  group_by(Ethnicity) %>% 
  summarize_if(is.numeric, mean, na.rm = T)
write_csv(rel_abund_tax_fecal_before_ethnicity, "tables/relab_fecal_before.csv")
rel_abund_tax_fecal_during = rel_abund_tax_fecal %>% 
  filter(`Study period` == "During")
rel_abund_tax_fecal_during_ethnicity = rel_abund_tax_fecal_during %>% 
  group_by(Ethnicity) %>% 
  summarize_if(is.numeric, mean, na.rm = T)
write_csv(rel_abund_tax_fecal_during_ethnicity, "tables/relab_fecal_during.csv")
rel_abund_tax_fecal_after = rel_abund_tax_fecal %>% 
  filter(`Study period` == "After")
rel_abund_tax_fecal_after_ethnicity = rel_abund_tax_fecal_after %>% 
  group_by(Ethnicity) %>% 
  summarize_if(is.numeric, mean, na.rm = T)
write_csv(rel_abund_tax_fecal_after_ethnicity, "tables/relab_fecal_after.csv")

rel_abund_tax_oral = rel_abund_tax_t %>% 
  filter(oral_use == 1)
rel_abund_tax_oral_ethnicity = rel_abund_tax_oral %>% 
  group_by(Ethnicity) %>% 
  summarize_if(is.numeric, mean, na.rm = T)
write_csv(rel_abund_tax_oral_ethnicity, "tables/relab_oral.csv")
rel_abund_tax_oral_before = rel_abund_tax_oral %>% 
  filter(`Study period` == "Before")
rel_abund_tax_oral_before_ethnicity = rel_abund_tax_oral_before %>% 
  group_by(Ethnicity) %>% 
  summarize_if(is.numeric, mean, na.rm = T)
write_csv(rel_abund_tax_oral_before_ethnicity, "tables/relab_oral_before.csv")
rel_abund_tax_oral_during = rel_abund_tax_oral %>% 
  filter(`Study period` == "During")
rel_abund_tax_oral_during_ethnicity = rel_abund_tax_oral_during %>% 
  group_by(Ethnicity) %>% 
  summarize_if(is.numeric, mean, na.rm = T)
write_csv(rel_abund_tax_oral_during_ethnicity, "tables/relab_oral_during.csv")
rel_abund_tax_oral_after = rel_abund_tax_oral %>% 
  filter(`Study period` == "After")
rel_abund_tax_oral_after_ethnicity = rel_abund_tax_oral_after %>% 
  group_by(Ethnicity) %>% 
  summarize_if(is.numeric, mean, na.rm = T)
write_csv(rel_abund_tax_oral_after_ethnicity, "tables/relab_oral_after.csv")
```

## PERMANOVAs

Bray-Curtis and Jaccard distance matrices are created using vegan (v2.5-7). Matrices are constructed for all oral samples, all fecal samples, and oral and fecal samples broken down by ethnicity and study stage.

```{r beta_metrics, error=FALSE}
bray_fecal = vegdist(relab_fecal_filtered[,2:9266], method = "bray")
jacc_fecal = vegdist(relab_fecal_filtered[,2:9266], method = "jaccard")
bray_fecal_black = vegdist(relab_fecal_filtered_black[,2:9266], 
                           method = "bray")
bray_fecal_white = vegdist(relab_fecal_filtered_white[,2:9266], 
                           method = "bray")
jacc_fecal_black = vegdist(relab_fecal_filtered_black[,2:9266], 
                           method = "jaccard")
jacc_fecal_white = vegdist(relab_fecal_filtered_white[,2:9266], 
                           method = "jaccard")
bray_fecal_before = vegdist(relab_fecal_filtered_before[,2:9266], 
                           method = "jaccard")
bray_fecal_during = vegdist(relab_fecal_filtered_during[,2:9266], 
                           method = "jaccard")
bray_fecal_after = vegdist(relab_fecal_filtered_after[,2:9266], 
                           method = "jaccard")
jacc_fecal_before = vegdist(relab_fecal_filtered_before[,2:9266], 
                           method = "jaccard")
jacc_fecal_during = vegdist(relab_fecal_filtered_during[,2:9266], 
                           method = "jaccard")
jacc_fecal_after = vegdist(relab_fecal_filtered_after[,2:9266], 
                           method = "jaccard") 

bray_oral = vegdist(relab_oral_filtered[,2:8063], method = "bray")
jacc_oral = vegdist(relab_oral_filtered[,2:272], method = "jaccard")
bray_oral_black = vegdist(relab_oral_filtered_black[,2:8063], method = "bray")
bray_oral_white = vegdist(relab_oral_filtered_white[,2:8063], method = "bray")
jacc_oral_black = vegdist(relab_oral_filtered_black[,2:8063], method = "jaccard")
jacc_oral_white = vegdist(relab_oral_filtered_white[,2:8063], method = "jaccard")
bray_oral_before = vegdist(relab_oral_filtered_before[,2:8063], 
                           method = "jaccard")
bray_oral_after = vegdist(relab_oral_filtered_after[,2:8063], 
                          method = "jaccard")
jacc_oral_before = vegdist(relab_oral_filtered_before[,2:8063], 
                           method = "jaccard")
jacc_oral_after = vegdist(relab_oral_filtered_after[,2:8063], 
                          method = "jaccard")
```

Differences in the taxonomic structure of the community associated with self-reported ethnicity, subject id, and study stage is assessed using permutational multivariate analysis of variance.

#### Bray-Curtis
Fecal
```{r permanova_brayf}
adonis2(bray_fecal ~ subject_id + `Study period` + subject_id*`Study period`, 
        data = relab_fecal_filtered, 
        permutations = 4999)
adonis2(bray_fecal ~ Ethnicity + `Study period` + `Antibiotic use` + `Contraceptive use`, data = relab_fecal_filtered, permutations = 4999)

adonis2(bray_fecal ~ Ethnicity, 
        data = relab_fecal_filtered, 
        permutations = 4999)
adonis2(bray_fecal_before ~ Ethnicity, 
        data = relab_fecal_filtered_before, 
        permutations = 4999)
adonis2(bray_fecal_during ~ Ethnicity, 
        data = relab_fecal_filtered_during, 
        permutations = 4999)
adonis2(bray_fecal_after ~ Ethnicity, 
        data = relab_fecal_filtered_after, 
        permutations = 4999)

adonis2(bray_fecal ~ `Study period`, 
        data = relab_fecal_filtered, 
        permutations = 4999)
adonis2(bray_fecal_black ~ `Study period`, 
        data = relab_fecal_filtered_black, 
        permutations = 4999)
adonis2(bray_fecal_white ~ `Study period`, 
        data = relab_fecal_filtered_white, 
        permutations = 4999)
```

Oral
```{r permanova_brayo}
adonis2(bray_oral ~ subject_id + `Study period`, 
        data = relab_oral_filtered, 
        permutations = 4999)
adonis2(bray_oral ~ Ethnicity + `Study period` + `Antibiotic use` + `Contraceptive use`, data = relab_oral_filtered, permutations = 4999)

adonis2(bray_oral ~ Ethnicity, 
        data = relab_oral_filtered, 
        permutations = 4999)
adonis2(bray_oral_before ~ Ethnicity, 
        data = relab_oral_filtered_before, 
        permutations = 4999)
adonis2(bray_oral_after ~ Ethnicity, 
        data = relab_oral_filtered_after, 
        permutations = 4999)

adonis2(bray_oral ~ `Study period`, 
        data = relab_oral_filtered, 
        permutations = 4999)
adonis2(bray_oral_black ~ `Study period`, 
        data = relab_oral_filtered_black, 
        permutations = 4999)
adonis2(bray_oral_white ~ `Study period`, 
        data = relab_oral_filtered_white, 
        permutations = 4999)

```

#### Jaccard
Fecal
```{r permanova_jaccf}
adonis2(jacc_fecal ~ subject_id + `Study period` + subject_id*`Study period`, 
        data = relab_fecal_filtered, 
        permutations = 4999)
adonis2(jacc_fecal ~ Ethnicity + `Study period` + `Antibiotic use` + `Contraceptive use`, data = relab_fecal_filtered, permutations = 4999)

adonis2(jacc_fecal ~ Ethnicity, 
        data = relab_fecal_filtered, 
        permutations = 4999)
adonis2(jacc_fecal_before ~ Ethnicity, 
        data = relab_fecal_filtered_before, 
        permutations = 4999)
adonis2(jacc_fecal_during ~ Ethnicity, 
        data = relab_fecal_filtered_during, 
        permutations = 4999)
adonis2(jacc_fecal_after ~ Ethnicity, 
        data = relab_fecal_filtered_after, 
        permutations = 4999)

adonis2(jacc_fecal ~ `Study period`, 
        data = relab_fecal_filtered, 
        permutations = 4999)
adonis2(jacc_fecal_black ~ `Study period`, 
        data = relab_fecal_filtered_black, 
        permutations = 4999)
adonis2(jacc_fecal_white ~ `Study period`, 
        data = relab_fecal_filtered_white, 
        permutations = 4999)
```

Oral
```{r permanova_jacco}
adonis2(jacc_oral ~ subject_id + `Study period`, 
        data = relab_oral_filtered, 
        permutations = 4999)
adonis2(bray_oral ~ Ethnicity + `Study period` + `Antibiotic use` + `Contraceptive use`, data = relab_oral_filtered, permutations = 4999)

adonis2(jacc_oral ~ Ethnicity, 
        data = relab_oral_filtered, 
        permutations = 4999)
adonis2(jacc_oral_before ~ Ethnicity, 
        data = relab_oral_filtered_before, 
        permutations = 4999)
adonis2(jacc_oral_after ~ Ethnicity, 
        data = relab_oral_filtered_after, 
        permutations = 4999)

adonis2(jacc_oral ~ `Study period`, 
        data = relab_oral_filtered, 
        permutations = 4999)
adonis2(jacc_oral_black ~ `Study period`, 
        data = relab_oral_filtered_black, 
        permutations = 4999)
adonis2(jacc_oral_white ~ `Study period`, 
        data = relab_oral_filtered_white, 
        permutations = 4999)
```

## Taxonomic abundance

Wilcoxon Rank Sum tests (base R) were used to assess if self-reported Ethnicity is associated with the abundance of individual species identified at the rank of genus or above. P-values are corrected using fdrtool (v.1.2.16).

```{r taxa_models_fecal}
Ethnicity_estimatematrix = mat.or.vec(182,2)
Ethnicity_pvaluematrix = mat.or.vec(182,2)

rel_abund_tax_fecal = as.data.frame(rel_abund_tax_fecal)

for(i in 2:183) {
  variable = rel_abund_tax_fecal[,i]
  b = wilcox.test(variable ~ Ethnicity, 
                  data = rel_abund_tax_fecal,
                  paired = F, exact = F)
  Ethnicity_estimatematrix[i-1,2] = b$statistic
  Ethnicity_pvaluematrix[i-1,2] = b$p.value
  Ethnicity_estimatematrix[i-1,1] = names(rel_abund_tax_fecal)[i]
  Ethnicity_pvaluematrix[i-1,1] = names(rel_abund_tax_fecal)[i]
}


taxa_Ethnicity = bind_cols(as.data.frame(Ethnicity_estimatematrix[,1:2]), 
                     as.data.frame(Ethnicity_pvaluematrix[,2]))
write.csv(taxa_Ethnicity, "tables/taxa_fecal_wilcox_Ethnicity_y2.csv")
taxa_Ethnicity_nona = filter(taxa_Ethnicity, taxa_Ethnicity[,3] != "NaN") 
taxa_Ethnicity_nona[,3] = as.numeric(as.character(taxa_Ethnicity_nona[,3]))
taxa_Ethnicity_corrected = bind_cols(taxa_Ethnicity_nona, 
                               as.data.frame(fdrtool(taxa_Ethnicity_nona[,3], 
                                                     statistic = "pvalue", 
                                                     plot = F)))
write.csv(taxa_Ethnicity_corrected_full, "tables/taxa_fecal_wilcox_Ethnicity_corrected_y2.csv")
```

```{r taxa_models_oral}
Ethnicity_estimatematrix = mat.or.vec(182,2)
Ethnicity_pvaluematrix = mat.or.vec(182,2)

rel_abund_tax_oral = as.data.frame(rel_abund_tax_oral)

for(i in 2:183) {
  variable = rel_abund_tax_oral[,i]
  b = wilcox.test(variable ~ Ethnicity, 
                  data = rel_abund_tax_oral,
                  paired = F, exact = F)
  Ethnicity_estimatematrix[i-1,2] = b$statistic
  Ethnicity_pvaluematrix[i-1,2] = b$p.value
  Ethnicity_estimatematrix[i-1,1] = names(rel_abund_tax_oral)[i]
  Ethnicity_pvaluematrix[i-1,1] = names(rel_abund_tax_oral)[i]
}

taxa_Ethnicity = bind_cols(as.data.frame(Ethnicity_estimatematrix[,1:2]), 
                     as.data.frame(Ethnicity_pvaluematrix[,2]))
write.csv(taxa_Ethnicity, "tables/taxa_oral_wilcox_Ethnicity_y2.csv")
taxa_Ethnicity_nona = filter(taxa_Ethnicity, taxa_Ethnicity[,3] != "NaN") 
taxa_Ethnicity_nona[,3] = as.numeric(as.character(taxa_Ethnicity_nona[,3]))
taxa_Ethnicity_corrected = bind_cols(taxa_Ethnicity_nona, 
                               as.data.frame(fdrtool(taxa_Ethnicity_nona[,3], 
                                                     statistic = "pvalue", 
                                                     plot = F)))
write.csv(taxa_Ethnicity_corrected, "tables/taxa_oral_wilcox_Ethnicity_corrected_y2.csv")
```

## Dendrogram

Import data and filter into fecal and oral metagenomes.

```{r dendro_import}
y1tax = read_tsv("taxon_meta_y1.txt")

y1taxoral = y1tax %>% 
  column_to_rownames("sample.name") %>% 
  filter(source == "oral") %>% 
  dplyr::select(7:9377)

y1taxfecal = y1tax %>% 
  column_to_rownames("sample.name") %>% 
  filter(source == "fecal") %>% 
  dplyr::select(7:9377)

y1vir = read_tsv("virome.txt")
y1virfecal = y1vir %>% 
  column_to_rownames("sample") %>% 
  dplyr::select(5:4429)

y2taxfecal = relab_fecal_filtered %>% 
  column_to_rownames("SampleID")%>% 
  dplyr::select(2:9266)

y2taxoral = relab_oral_filtered %>% 
  column_to_rownames("SampleID")%>% 
  dplyr::select(2:8063)
```
Create labeled dendrograms for fecal and oral samples in each year.

```{r dendro_y1fecal}
y1fecal.dist <- vegdist(y1taxfecal, method = "bray", permutations = 999)
y1fecal.clus <- hclust(y1fecal.dist, "aver")

y1fcd = as.dendrogram(y1fecal.clus) 

y1taxf = y1tax %>% filter(source == "fecal")
Ethnicity = rep("Black", length(rownames(y1taxf)))
is_x = grepl("Caucasian", y1taxf$Ethnicity)
Ethnicity[is_x] = "White"
Ethnicity = factor(Ethnicity)
n_Ethnicity = length(unique(Ethnicity))
cols_2 = c(White = "#87ceeb", Black = "#f5c4ca")
col_Ethnicity = cols_2[Ethnicity]

Stage = rep("Before", length(rownames(y1taxf)))
is_x = grepl("during", y1taxf$stage)
Stage[is_x] = "During"
is_x = grepl("after", y1taxf$stage)
Stage[is_x] = "After"
Stage = factor(Stage)
n_Stage = length(unique(Stage))
cols_3 = c("Before" = "#4daf4a", "During" = "#e41a1c", "After" = "#377eb8")
col_Stage = cols_3[Stage]

Subject = rep("1", length(rownames(y1taxfecal)))
is_x = grepl("02", rownames(y1taxfecal))
Subject[is_x] = "2"
is_x = grepl("03", rownames(y1taxfecal))
Subject[is_x] = "3"
is_x = grepl("04", rownames(y1taxfecal))
Subject[is_x] = "4"
is_x = grepl("05", rownames(y1taxfecal))
Subject[is_x] = "5"
is_x = grepl("06", rownames(y1taxfecal))
Subject[is_x] = "6"
is_x = grepl("07", rownames(y1taxfecal))
Subject[is_x] = "7"
is_x = grepl("03", rownames(y1taxfecal))
Subject[is_x] = "3"
is_x = grepl("08", rownames(y1taxfecal))
Subject[is_x] = "8"
is_x = grepl("09", rownames(y1taxfecal))
Subject[is_x] = "9"
is_x = grepl("10", rownames(y1taxfecal))
Subject[is_x] = "10"
is_x = grepl("11", rownames(y1taxfecal))
Subject[is_x] = "11"
is_x = grepl("12", rownames(y1taxfecal))
Subject[is_x] = "12"
is_x = grepl("13", rownames(y1taxfecal))
Subject[is_x] = "13"
is_x = grepl("14", rownames(y1taxfecal))
Subject[is_x] = "14"
is_x = grepl("15", rownames(y1taxfecal))
Subject[is_x] = "15"
is_x = grepl("16", rownames(y1taxfecal))
Subject[is_x] = "16"
is_x = grepl("17", rownames(y1taxfecal))
Subject[is_x] = "17"
is_x = grepl("19", rownames(y1taxfecal))
Subject[is_x] = "19"
is_x = grepl("20", rownames(y1taxfecal))
Subject[is_x] = "20"
Subject = factor(Subject)
n_Subject = length(unique(Subject))
cols_19 = colorspace::rainbow_hcl(n_Subject, c = 50, l = 70)
col_Subject = cols_19[Subject]
labels_colors(y1fcd) = col_Subject[order.dendrogram(y1fcd)]

svg("figures/y1_fecal_dendrogram.svg", width = 15, height = 10)
y1fcd = assign_values_to_leaves_edgePar(y1fcd, 
                                        value = col_Subject[order.dendrogram(y1fcd)], edgePar = "col") %>% 
  set("branches_lwd", 4)
layout.matrix = matrix(c(1,2), nrow = 2, ncol = 1)
layout(mat = layout.matrix, heights = c(6, 1))
plot(y1fcd)
colored_bars(cbind(col_Ethnicity[order.dendrogram(y1fcd)], 
                   col_Stage[order.dendrogram(y1fcd)]), 
             y1fcd)
dev.off()
```

```{r dendro_y1oral}
y1oral.dist <- vegdist(y1taxoral, method = "bray", permutations = 999)
y1oral.clus <- hclust(y1oral.dist, "aver")

y1ocd = as.dendrogram(y1oral.clus) 

y1taxo = y1tax %>% filter(source == "oral")

Ethnicity = rep("Black", length(rownames(y1taxo)))
is_x = grepl("Caucasian", y1taxo$Ethnicity)
Ethnicity[is_x] = "White"
Ethnicity = factor(Ethnicity)
n_Ethnicity = length(unique(Ethnicity))
cols_2 = c(White = "#87ceeb", Black = "#f5c4ca")
col_Ethnicity = cols_2[Ethnicity]

Stage = rep("Before", length(rownames(y1taxo)))
is_x = grepl("after", y1taxo$stage)
Stage[is_x] = "After"
Stage = factor(Stage)
n_Stage = length(unique(Stage))
cols_3 = c("Before" = "#4daf4a", "After" = "#377eb8")
col_Stage = cols_3[Stage]

Subject = rep("1", length(rownames(y1taxoral)))
is_x = grepl("02", rownames(y1taxoral))
Subject[is_x] = "2"
is_x = grepl("03", rownames(y1taxoral))
Subject[is_x] = "3"
is_x = grepl("04", rownames(y1taxoral))
Subject[is_x] = "4"
is_x = grepl("05", rownames(y1taxoral))
Subject[is_x] = "5"
is_x = grepl("06", rownames(y1taxoral))
Subject[is_x] = "6"
is_x = grepl("07", rownames(y1taxoral))
Subject[is_x] = "7"
is_x = grepl("08", rownames(y1taxoral))
Subject[is_x] = "8"
is_x = grepl("09", rownames(y1taxoral))
Subject[is_x] = "9"
is_x = grepl("10", rownames(y1taxoral))
Subject[is_x] = "10"
is_x = grepl("11", rownames(y1taxoral))
Subject[is_x] = "11"
is_x = grepl("12", rownames(y1taxoral))
Subject[is_x] = "12"
is_x = grepl("13", rownames(y1taxoral))
Subject[is_x] = "13"
is_x = grepl("14", rownames(y1taxoral))
Subject[is_x] = "14"
is_x = grepl("15", rownames(y1taxoral))
Subject[is_x] = "15"
is_x = grepl("16", rownames(y1taxoral))
Subject[is_x] = "16"
is_x = grepl("17", rownames(y1taxoral))
Subject[is_x] = "17"
is_x = grepl("19", rownames(y1taxoral))
Subject[is_x] = "19"
is_x = grepl("20", rownames(y1taxoral))
Subject[is_x] = "20"
Subject = factor(Subject)
n_Subject = length(unique(Subject))
cols_19 = colorspace::rainbow_hcl(n_Subject, c = 50, l = 70)
col_Subject = cols_19[Subject]
labels_colors(y1ocd) = col_Subject[order.dendrogram(y1ocd)]

svg("figures/y1_oral_dendrogram.svg", width = 15, height = 10)
y1ocd = assign_values_to_leaves_edgePar(y1ocd, 
                                        value = col_Subject[order.dendrogram(y1ocd)], edgePar = "col") %>% 
  set("branches_lwd", 4)
layout.matrix = matrix(c(1,2), nrow = 2, ncol = 1)
layout(mat = layout.matrix, heights = c(6, 1))
plot(y1ocd)
colored_bars(cbind(col_Ethnicity[order.dendrogram(y1ocd)], 
                   col_Stage[order.dendrogram(y1ocd)]), 
             y1ocd)
dev.off()
```
```{r dendro_y1virus}
y1virus.dist <- vegdist(y1virfecal, method = "bray", permutations = 999)
y1virus.clus <- hclust(y1virus.dist, "aver")

y1vcd = as.dendrogram(y1virus.clus) 

Ethnicity = rep("Black", length(rownames(y1vir)))
is_x = grepl("Caucasian", y1vir$Ethnicity)
Ethnicity[is_x] = "White"
Ethnicity = factor(Ethnicity)
n_Ethnicity = length(unique(Ethnicity))
cols_2 = c(White = "#87ceeb", Black = "#f5c4ca")
col_Ethnicity = cols_2[Ethnicity]

Stage = rep("Before", length(rownames(y1vir)))
is_x = grepl("during", y1vir$Stage)
Stage[is_x] = "During"
is_x = grepl("after", y1vir$Stage)
Stage[is_x] = "After"
Stage = factor(Stage)
n_Stage = length(unique(Stage))
cols_3 = c("Before" = "#4daf4a", "During" = "#e41a1c", "After" = "#377eb8")
col_Stage = cols_3[Stage]

Subject = rep("1", length(rownames(y1virfecal)))
is_x = grepl("02", rownames(y1virfecal))
Subject[is_x] = "2"
is_x = grepl("03", rownames(y1virfecal))
Subject[is_x] = "3"
is_x = grepl("04", rownames(y1virfecal))
Subject[is_x] = "4"
is_x = grepl("05", rownames(y1virfecal))
Subject[is_x] = "5"
is_x = grepl("06", rownames(y1virfecal))
Subject[is_x] = "6"
is_x = grepl("07", rownames(y1virfecal))
Subject[is_x] = "7"
is_x = grepl("08", rownames(y1virfecal))
Subject[is_x] = "8"
is_x = grepl("09", rownames(y1virfecal))
Subject[is_x] = "9"
is_x = grepl("10", rownames(y1virfecal))
Subject[is_x] = "10"
is_x = grepl("11", rownames(y1virfecal))
Subject[is_x] = "11"
is_x = grepl("12", rownames(y1virfecal))
Subject[is_x] = "12"
is_x = grepl("13", rownames(y1virfecal))
Subject[is_x] = "13"
is_x = grepl("14", rownames(y1virfecal))
Subject[is_x] = "14"
is_x = grepl("15", rownames(y1virfecal))
Subject[is_x] = "15"
is_x = grepl("16", rownames(y1virfecal))
Subject[is_x] = "16"
is_x = grepl("17", rownames(y1virfecal))
Subject[is_x] = "17"
is_x = grepl("19", rownames(y1virfecal))
Subject[is_x] = "19"
is_x = grepl("20", rownames(y1virfecal))
Subject[is_x] = "20"
Subject = factor(Subject)
n_Subject = length(unique(Subject))
cols_19 = colorspace::rainbow_hcl(n_Subject, c = 50, l = 70)
col_Subject = cols_19[Subject]
labels_colors(y1vcd) = col_Subject[order.dendrogram(y1vcd)]

svg("figures/y1_virus_dendrogram.svg", width = 15, height = 10)
y1vcd = assign_values_to_leaves_edgePar(y1vcd, 
                                        value = col_Subject[order.dendrogram(y1vcd)], edgePar = "col") %>% 
  set("branches_lwd", 4)
layout.matrix = matrix(c(1,2), nrow = 2, ncol = 1)
layout(mat = layout.matrix, heights = c(6, 1))
plot(y1vcd)
colored_bars(cbind(col_Ethnicity[order.dendrogram(y1vcd)], 
                   col_Stage[order.dendrogram(y1vcd)]), 
             y1vcd)
dev.off()
```

```{r dendro_y2fecal}
y2fecal.dist <- vegdist(y2taxfecal, method = "bray", permutations = 999)
y2fecal.clus <- hclust(y2fecal.dist, "aver")

y2fcd = as.dendrogram(y2fecal.clus) 

y2taxf = relab_fecal_filtered %>% 
  dplyr::select(9266:9291)
Ethnicity = rep("Black", length(rownames(y2taxf)))
is_x = grepl("White", y2taxf$Ethnicity)
Ethnicity[is_x] = "White"
Ethnicity = factor(Ethnicity)
n_Ethnicity = length(unique(Ethnicity))
cols_2 = c(White = "#87ceeb", Black = "#f5c4ca")
col_Ethnicity = cols_2[Ethnicity]

Stage = rep("Before", length(rownames(y2taxf)))
is_x = grepl("During", y2taxf$`Study period`)
Stage[is_x] = "During"
is_x = grepl("After", y2taxf$`Study period`)
Stage[is_x] = "After"
Stage = factor(Stage)
n_Stage = length(unique(Stage))
cols_3 = c("Before" = "#4daf4a", "During" = "#e41a1c", "After" = "#377eb8")
col_Stage = cols_3[Stage]

Subject = rep("21", length(rownames(y2taxfecal)))
is_x = grepl("22", rownames(y2taxfecal))
Subject[is_x] = "22"
is_x = grepl("23", rownames(y2taxfecal))
Subject[is_x] = "23"
is_x = grepl("24", rownames(y2taxfecal))
Subject[is_x] = "24"
is_x = grepl("25", rownames(y2taxfecal))
Subject[is_x] = "25"
is_x = grepl("26", rownames(y2taxfecal))
Subject[is_x] = "26"
is_x = grepl("27", rownames(y2taxfecal))
Subject[is_x] = "27"
is_x = grepl("29", rownames(y2taxfecal))
Subject[is_x] = "29"
is_x = grepl("30", rownames(y2taxfecal))
Subject[is_x] = "30"
is_x = grepl("31", rownames(y2taxfecal))
Subject[is_x] = "31"
is_x = grepl("32", rownames(y2taxfecal))
Subject[is_x] = "32"
is_x = grepl("33", rownames(y2taxfecal))
Subject[is_x] = "33"
is_x = grepl("34", rownames(y2taxfecal))
Subject[is_x] = "34"
is_x = grepl("35", rownames(y2taxfecal))
Subject[is_x] = "35"
is_x = grepl("36", rownames(y2taxfecal))
Subject[is_x] = "36"
is_x = grepl("37", rownames(y2taxfecal))
Subject[is_x] = "37"
is_x = grepl("38", rownames(y2taxfecal))
Subject[is_x] = "38"
Subject = factor(Subject)
n_Subject = length(unique(Subject))
cols_19 = colorspace::rainbow_hcl(n_Subject, c = 30, l = 50)
col_Subject = cols_19[Subject]
labels_colors(y2fcd) = col_Subject[order.dendrogram(y2fcd)]

svg("figures/y2_fecal_dendrogram.svg", width = 15, height = 10)
y2fcd = assign_values_to_leaves_edgePar(y2fcd, 
                                        value = col_Subject[order.dendrogram(y2fcd)], edgePar = "col") %>% 
  set("branches_lwd", 4)
layout.matrix = matrix(c(1,2), nrow = 2, ncol = 1)
layout(mat = layout.matrix, heights = c(6, 1))
plot(y2fcd)
colored_bars(cbind(col_Ethnicity[order.dendrogram(y2fcd)], 
                   col_Stage[order.dendrogram(y2fcd)]), 
             y2fcd)
dev.off()
```

```{r dendro_y2oral}
y2oral.dist <- vegdist(y2taxoral, method = "bray", permutations = 999)
y2oral.clus <- hclust(y2oral.dist, "aver")

y2ocd = as.dendrogram(y2oral.clus) 

y2taxo = relab_oral_filtered %>% 
  dplyr::select(8064:8088)

Ethnicity = rep("Black", length(rownames(y2taxo)))
is_x = grepl("White", y2taxo$Ethnicity)
Ethnicity[is_x] = "White"
Ethnicity = factor(Ethnicity)
n_Ethnicity = length(unique(Ethnicity))
cols_2 = c(White = "#87ceeb", Black = "#f5c4ca")
col_Ethnicity = cols_2[Ethnicity]

Stage = rep("Before", length(rownames(y2taxo)))
is_x = grepl("After", y2taxo$`Study period`)
Stage[is_x] = "After"
Stage = factor(Stage)
n_Stage = length(unique(Stage))
cols_3 = c("Before" = "#4daf4a", "After" = "#377eb8")
col_Stage = cols_3[Stage]

Subject = rep("21", length(rownames(y2taxoral)))
is_x = grepl("22", rownames(y2taxoral))
Subject[is_x] = "22"
is_x = grepl("23", rownames(y2taxoral))
Subject[is_x] = "23"
is_x = grepl("24", rownames(y2taxoral))
Subject[is_x] = "24"
is_x = grepl("25", rownames(y2taxoral))
Subject[is_x] = "25"
is_x = grepl("26", rownames(y2taxoral))
Subject[is_x] = "26"
is_x = grepl("27", rownames(y2taxoral))
Subject[is_x] = "27"
is_x = grepl("29", rownames(y2taxoral))
Subject[is_x] = "29"
is_x = grepl("30", rownames(y2taxoral))
Subject[is_x] = "30"
is_x = grepl("31", rownames(y2taxoral))
Subject[is_x] = "31"
is_x = grepl("32", rownames(y2taxoral))
Subject[is_x] = "32"
is_x = grepl("33", rownames(y2taxoral))
Subject[is_x] = "33"
is_x = grepl("34", rownames(y2taxoral))
Subject[is_x] = "34"
is_x = grepl("35", rownames(y2taxoral))
Subject[is_x] = "35"
is_x = grepl("36", rownames(y2taxoral))
Subject[is_x] = "36"
is_x = grepl("37", rownames(y2taxoral))
Subject[is_x] = "37"
is_x = grepl("38", rownames(y2taxoral))
Subject[is_x] = "38"
Subject = factor(Subject)
n_Subject = length(unique(Subject))
cols_19 = colorspace::rainbow_hcl(n_Subject, c = 30, l = 50)
col_Subject = cols_19[Subject]
labels_colors(y2ocd) = col_Subject[order.dendrogram(y2ocd)]

svg("figures/y2_oral_dendrogram.svg", width = 15, height = 10)
y2ocd = assign_values_to_leaves_edgePar(y2ocd, 
                                        value = col_Subject[order.dendrogram(y2ocd)], edgePar = "col") %>% 
  set("branches_lwd", 4)
layout.matrix = matrix(c(1,2), nrow = 2, ncol = 1)
layout(mat = layout.matrix, heights = c(6, 1))
plot(y2ocd)
colored_bars(cbind(col_Ethnicity[order.dendrogram(y2ocd)], 
                   col_Stage[order.dendrogram(y2ocd)]), 
             y2ocd)
dev.off()
```
