---
title: "Taxonomy Contigs"
author: "Liz Mallott"
date: "3/29/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Set up environment

```{r libraries}
library(tidyverse)
library(fdrtool)
```

## Import data

Taxids with taxonomy are imported. Relative abundances of each taxid for individual samples are imported and vertically appended. We then reshape the dataframe. Taxid file and relative abundance file are joined to append taxonomy.

```{r import_taxonomy, echo = F}
taxid = read_tsv("taxonomy_files/tax.txt") %>% 
  select(-contig) %>% 
  distinct()
write_csv(taxid, "tables/unique_taxid.csv")
ra_files = list.files(path = "taxonomy_files", pattern = "run", full.names = T)
rel_abund_long = map_dfr(ra_files, read_tsv)
rel_abund_notax = rel_abund_long %>% pivot_wider(names_from = "id", values_from = "relative")
rel_abund = rel_abund_notax %>% right_join(taxid)
```

Metadata is imported.
```{r import_metadata, echo = F}
metadata = read_tsv("year2_sample_mapping.txt")
metadata2 = metadata %>% 
  mutate(Ethnicity = case_when(Ethnicity == "African_American" ~ "Black", 
                               Ethnicity == "Caucasian" ~ "White"))
```

## Filter data

The relative abundance table is transposed (without taxonomy) and file names are cleaned up. It is then joined with the metadata for PERMANOVA analyses. Individual tables for fecal and oral samples for each study period and for each ethnicity are created.
```{r ra_perm}
rel_abund_t = rel_abund_notax %>% 
  pivot_longer(cols = 2:163, names_to = "file_prefix", values_to = "relative_abundance") %>% 
  pivot_wider(names_from = "taxid", values_from = "relative_abundance") %>% 
  mutate_at("file_prefix", str_replace, "-", "_") %>% 
  left_join(metadata2)
relab_fecal = rel_abund_t %>% 
  filter(fecal_use == 1)
relab_fecal_filtered = relab_fecal %>% 
  mutate(total = rowSums(relab_fecal[,2:9395])) %>% 
  filter(total > 0) %>% 
  select_if(~ !is.numeric(.) || sum(.) != 0)
relab_fecal_filtered_black = relab_fecal_filtered %>% 
  filter(Ethnicity == "Black")
relab_fecal_filtered_white = relab_fecal_filtered %>% 
  filter(Ethnicity == "White")
relab_fecal_filtered_before = relab_fecal_filtered %>% 
  filter(`Study period` == "Before")
relab_fecal_filtered_during = relab_fecal_filtered %>% 
  filter(`Study period` == "During")
relab_fecal_filtered_after = relab_fecal_filtered %>% 
  filter(`Study period` == "After")

relab_oral= rel_abund_t %>% 
  filter(oral_use == 1)
relab_oral_filtered = relab_oral %>% 
  mutate(total = rowSums(relab_oral[,2:9395])) %>% 
  filter(total > 0) %>% 
  select_if(~ !is.numeric(.) || sum(.) != 0)
relab_oral_filtered_black = relab_oral_filtered %>% 
  filter(Ethnicity == "Black")
relab_oral_filtered_white = relab_oral_filtered %>% 
  filter(Ethnicity == "White")
relab_oral_filtered_before = relab_oral_filtered %>% 
  filter(`Study period` == "Before")
relab_oral_filtered_after = relab_oral_filtered %>% 
  filter(`Study period` == "After")
```

The relative abundance table is transposed (with species names but no taxids), column names are cleaned up, low abundance taxa (<1%) are removed, and it is joined with the metadata for individual taxa abundance analyses. Individual tables for fecal and oral samples for each study period and for each ethnicity are created.

```{r ra_taxabund}
rel_abund_tax_t = rel_abund %>% 
  filter(Kingdom == "Bacteria") %>% 
  select(-164) %>% 
  unite("Sci_name", Genus:Species, na.rm = F) %>% 
  pivot_longer(cols = 1:162, names_to = "file_prefix", values_to = "relative_abundance") %>%
  filter(Sci_name != "NA_NA") %>% 
  group_by(Sci_name, file_prefix) %>% 
  summarize(relative_abundance = sum(relative_abundance)) %>% 
  pivot_wider(names_from = "Sci_name", values_from = "relative_abundance") %>% 
  mutate_at("file_prefix", str_replace, "-", "_") %>% 
  select_if(~max(.) >= 0.01) %>% 
  left_join(metadata2)

rel_abund_tax_fecal = rel_abund_tax_t %>% 
  filter(fecal_use == 1) 
rel_abund_tax_fecal_ethnicity = rel_abund_tax_fecal %>% 
  group_by(Ethnicity) %>% 
  summarize_if(is.numeric, mean, na.rm = T)
write_csv(rel_abund_tax_fecal_ethnicity, "tables/relab_fecal.csv")
rel_abund_tax_fecal_before = rel_abund_tax_fecal %>% 
  filter(`Study period` == "Before")
rel_abund_tax_fecal_before_ethnicity = rel_abund_tax_fecal_before %>% 
  group_by(Ethnicity) %>% 
  summarize_if(is.numeric, mean, na.rm = T)
write_csv(rel_abund_tax_fecal_before_ethnicity, "tables/relab_fecal_before.csv")
rel_abund_tax_fecal_during = rel_abund_tax_fecal %>% 
  filter(`Study period` == "During")
rel_abund_tax_fecal_during_ethnicity = rel_abund_tax_fecal_during %>% 
  group_by(Ethnicity) %>% 
  summarize_if(is.numeric, mean, na.rm = T)
write_csv(rel_abund_tax_fecal_during_ethnicity, "tables/relab_fecal_during.csv")
rel_abund_tax_fecal_after = rel_abund_tax_fecal %>% 
  filter(`Study period` == "After")
rel_abund_tax_fecal_after_ethnicity = rel_abund_tax_fecal_after %>% 
  group_by(Ethnicity) %>% 
  summarize_if(is.numeric, mean, na.rm = T)
write_csv(rel_abund_tax_fecal_after_ethnicity, "tables/relab_fecal_after.csv")

rel_abund_tax_oral = rel_abund_tax_t %>% 
  filter(oral_use == 1)
rel_abund_tax_oral_ethnicity = rel_abund_tax_oral %>% 
  group_by(Ethnicity) %>% 
  summarize_if(is.numeric, mean, na.rm = T)
write_csv(rel_abund_tax_oral_ethnicity, "tables/relab_oral.csv")
rel_abund_tax_oral_before = rel_abund_tax_oral %>% 
  filter(`Study period` == "Before")
rel_abund_tax_oral_before_ethnicity = rel_abund_tax_oral_before %>% 
  group_by(Ethnicity) %>% 
  summarize_if(is.numeric, mean, na.rm = T)
write_csv(rel_abund_tax_oral_before_ethnicity, "tables/relab_oral_before.csv")
rel_abund_tax_oral_during = rel_abund_tax_oral %>% 
  filter(`Study period` == "During")
rel_abund_tax_oral_during_ethnicity = rel_abund_tax_oral_during %>% 
  group_by(Ethnicity) %>% 
  summarize_if(is.numeric, mean, na.rm = T)
write_csv(rel_abund_tax_oral_during_ethnicity, "tables/relab_oral_during.csv")
rel_abund_tax_oral_after = rel_abund_tax_oral %>% 
  filter(`Study period` == "After")
rel_abund_tax_oral_after_ethnicity = rel_abund_tax_oral_after %>% 
  group_by(Ethnicity) %>% 
  summarize_if(is.numeric, mean, na.rm = T)
write_csv(rel_abund_tax_oral_after_ethnicity, "tables/relab_oral_after.csv")
```

### Taxonomic abundance

Wilcoxon Rank Sum tests were used to assess if self-reported Ethnicity is associated with the abundance of individual species identified at the rank of genus or above.

```{r taxa_models_fecal}
Ethnicity_estimatematrix = mat.or.vec(182,2)
Ethnicity_pvaluematrix = mat.or.vec(182,2)

rel_abund_tax_fecal = as.data.frame(rel_abund_tax_fecal)

for(i in 2:183) {
  variable = rel_abund_tax_fecal[,i]
  b = wilcox.test(variable ~ Ethnicity, 
                  data = rel_abund_tax_fecal,
                  paired = F, exact = F)
  Ethnicity_estimatematrix[i-1,2] = b$statistic
  Ethnicity_pvaluematrix[i-1,2] = b$p.value
  Ethnicity_estimatematrix[i-1,1] = names(rel_abund_tax_fecal)[i]
  Ethnicity_pvaluematrix[i-1,1] = names(rel_abund_tax_fecal)[i]
}


taxa_Ethnicity = bind_cols(as.data.frame(Ethnicity_estimatematrix[,1:2]), 
                     as.data.frame(Ethnicity_pvaluematrix[,2]))
write.csv(taxa_Ethnicity, "tables/taxa_fecal_wilcox_Ethnicity_y2.csv")
taxa_Ethnicity_nona = filter(taxa_Ethnicity, taxa_Ethnicity[,3] != "NaN") 
taxa_Ethnicity_nona[,3] = as.numeric(as.character(taxa_Ethnicity_nona[,3]))
taxa_Ethnicity_corrected = bind_cols(taxa_Ethnicity_nona, 
                               as.data.frame(fdrtool(taxa_Ethnicity_nona[,3], 
                                                     statistic = "pvalue", 
                                                     plot = F)))
write.csv(taxa_Ethnicity_corrected_full, "tables/taxa_fecal_wilcox_Ethnicity_corrected_y2.csv")
```

```{r taxa_models_oral}
Ethnicity_estimatematrix = mat.or.vec(182,2)
Ethnicity_pvaluematrix = mat.or.vec(182,2)

rel_abund_tax_oral = as.data.frame(rel_abund_tax_oral)

for(i in 2:183) {
  variable = rel_abund_tax_oral[,i]
  b = wilcox.test(variable ~ Ethnicity, 
                  data = rel_abund_tax_oral,
                  paired = F, exact = F)
  Ethnicity_estimatematrix[i-1,2] = b$statistic
  Ethnicity_pvaluematrix[i-1,2] = b$p.value
  Ethnicity_estimatematrix[i-1,1] = names(rel_abund_tax_oral)[i]
  Ethnicity_pvaluematrix[i-1,1] = names(rel_abund_tax_oral)[i]
}

taxa_Ethnicity = bind_cols(as.data.frame(Ethnicity_estimatematrix[,1:2]), 
                     as.data.frame(Ethnicity_pvaluematrix[,2]))
write.csv(taxa_Ethnicity, "tables/taxa_oral_wilcox_Ethnicity_y2.csv")
taxa_Ethnicity_nona = filter(taxa_Ethnicity, taxa_Ethnicity[,3] != "NaN") 
taxa_Ethnicity_nona[,3] = as.numeric(as.character(taxa_Ethnicity_nona[,3]))
taxa_Ethnicity_corrected = bind_cols(taxa_Ethnicity_nona, 
                               as.data.frame(fdrtool(taxa_Ethnicity_nona[,3], 
                                                     statistic = "pvalue", 
                                                     plot = F)))
write.csv(taxa_Ethnicity_corrected, "tables/taxa_oral_wilcox_Ethnicity_corrected_y2.csv")
```

